#!/bin/bash
# Build client
set -e
cd "$(dirname "$(dirname "$0")")/client"


# Clear existing
rm -rf dist


# Build css
node_modules/.bin/sass --style=compressed src/css/index.sass dist/client.css


# Common args
esbuild="../node_modules/.bin/esbuild --sourcemap --target=es6"


# Build ESM and CJS versions
$esbuild --format=esm  --platform=neutral --outdir=dist/esm ./src/*.ts
$esbuild --format=cjs  --platform=node    --outdir=dist/cjs ./src/*.ts


# Add typings for the ESM version
../node_modules/.bin/tsc --emitDeclarationOnly --outDir dist/esm


# Build bundled minified versions as ESM and IIFE
$esbuild --format=esm  --platform=neutral --outfile=dist/client.min.esm.js  --bundle --minify src/index.ts
$esbuild --format=iife --platform=browser --outfile=dist/client.min.iife.js --bundle --minify src/index.ts


# Copy to site so example and users can use if they want
cp dist/client.min.esm.js ../site/src/public/client.min.esm.js
cp dist/client.min.esm.js ../site/src/public/client.min.esm.js.map
cp dist/client.min.iife.js ../site/src/public/client.min.iife.js
cp dist/client.min.iife.js ../site/src/public/client.min.iife.js.map


# Put in comp dir as well as Vitepress doesn't like importing from public
cp dist/client.min.esm.js ../site/src/.comp/client.min.esm.js
